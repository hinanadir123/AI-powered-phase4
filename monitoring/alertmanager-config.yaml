apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: '${{ secrets.SMTP_FROM_EMAIL }}'
      smtp_auth_username: '${{ secrets.SMTP_USERNAME }}'
      smtp_auth_password: '${{ secrets.SMTP_PASSWORD }}'

    route:
      group_by: ['alertname', 'priority']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'default-receiver'
      routes:
        - matchers:
            - severity = "critical"
          receiver: 'critical-team'
        - matchers:
            - alertname = "CPUHigh"
          receiver: 'dev-team'
        - matchers:
            - alertname = "MemoryHigh"
          receiver: 'dev-team'
        - matchers:
            - alertname =~ "Kafka.*"
          receiver: 'kafka-team'

    receivers:
      - name: 'default-receiver'
        email_configs:
          - to: '${{ secrets.DEFAULT_ALERT_EMAIL }}'
            send_resolved: true
      - name: 'critical-team'
        email_configs:
          - to: '${{ secrets.CRITICAL_ALERT_EMAIL }}'
            send_resolved: true
        slack_configs:
          - api_url: '${{ secrets.SLACK_WEBHOOK_URL }}'
            send_resolved: true
            title: '{{ template "slack.default.title" . }}'
            text: '{{ template "slack.default.text" . }}'
      - name: 'dev-team'
        email_configs:
          - to: '${{ secrets.DEV_TEAM_EMAIL }}'
            send_resolved: true
      - name: 'kafka-team'
        email_configs:
          - to: '${{ secrets.KAFKA_TEAM_EMAIL }}'
            send_resolved: true

    templates:
      - '/etc/alertmanager/template/*.tmpl'

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
data:
  default.tmpl: |
    {{ define "slack.default.title" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
    {{ end }}

    {{ define "slack.default.text" }}
    {{ range .Alerts }}
      *Alert:* {{ .Labels.alertname }} - `{{ .Labels.severity }}`
      *Description:* {{ .Annotations.description }}
      *Graph:* <{{ .GeneratorURL }}|View it in Prometheus>
      *Details:*
        {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
        {{ end }}
    {{ end }}
    {{ end }}