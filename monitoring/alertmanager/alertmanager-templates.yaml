# Task: T5.6.4 - Alertmanager Notification Templates
# Implements: phase5-spec.md Section 7.4 (Alerting)
# Generated by: cicd-monitoring-agent
# Date: 2026-02-15

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
  labels:
    app: alertmanager
    component: alerting
data:
  default.tmpl: |
    {{ define "__alertmanager" }}Alertmanager{{ end }}
    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}

    {{ define "__description" }}{{ end }}

    {{ define "__text_alert_list" }}{{ range . }}
    Labels:
    {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}
    {{ end }}Annotations:
    {{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }}
    {{ end }}Source: {{ .GeneratorURL }}
    {{ end }}{{ end }}

    {{/* Default */}}
    {{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}
    {{ define "slack.default.username" }}{{ template "__alertmanager" . }}{{ end }}
    {{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}
    {{ define "slack.default.pretext" }}{{ end }}
    {{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}
    {{ define "slack.default.iconemoji" }}{{ end }}
    {{ define "slack.default.iconurl" }}{{ end }}
    {{ define "slack.default.text" }}{{ end }}

    {{/* Email templates */}}
    {{ define "email.default.subject" }}{{ template "__subject" . }}{{ end }}

    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        body {
          font-family: Arial, sans-serif;
          line-height: 1.6;
          color: #333;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background-color: #f4f4f4;
          padding: 20px;
          border-radius: 5px;
          margin-bottom: 20px;
        }
        .alert {
          border-left: 4px solid #ff6b6b;
          padding: 15px;
          margin-bottom: 15px;
          background-color: #fff5f5;
        }
        .alert.warning {
          border-left-color: #ffa500;
          background-color: #fff8e1;
        }
        .alert.resolved {
          border-left-color: #51cf66;
          background-color: #f0fdf4;
        }
        .label {
          display: inline-block;
          background-color: #e9ecef;
          padding: 3px 8px;
          border-radius: 3px;
          margin: 2px;
          font-size: 12px;
        }
        .button {
          display: inline-block;
          padding: 10px 20px;
          background-color: #007bff;
          color: white;
          text-decoration: none;
          border-radius: 5px;
          margin: 5px;
        }
        .footer {
          margin-top: 30px;
          padding-top: 20px;
          border-top: 1px solid #ddd;
          font-size: 12px;
          color: #666;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h2>{{ if eq .Status "firing" }}ðŸ”¥ Alert Firing{{ else }}âœ… Alert Resolved{{ end }}</h2>
        <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
        <p><strong>Group:</strong> {{ .GroupLabels.SortedPairs.Values | join " " }}</p>
        <p><strong>Time:</strong> {{ .CommonAnnotations.timestamp }}</p>
      </div>

      {{ if gt (len .Alerts.Firing) 0 }}
      <h3>ðŸ”´ Firing Alerts ({{ .Alerts.Firing | len }})</h3>
      {{ range .Alerts.Firing }}
      <div class="alert {{ if eq .Labels.severity "warning" }}warning{{ end }}">
        <h4>{{ .Labels.alertname }}</h4>
        <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>

        <p><strong>Labels:</strong></p>
        <div>
          {{ range .Labels.SortedPairs }}
          <span class="label">{{ .Name }}: {{ .Value }}</span>
          {{ end }}
        </div>

        <p style="margin-top: 15px;">
          <a href="{{ .Annotations.dashboard }}" class="button">View Dashboard</a>
          <a href="{{ .Annotations.runbook }}" class="button">View Runbook</a>
        </p>

        <p style="font-size: 12px; color: #666;">
          <strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
        </p>
      </div>
      {{ end }}
      {{ end }}

      {{ if gt (len .Alerts.Resolved) 0 }}
      <h3>âœ… Resolved Alerts ({{ .Alerts.Resolved | len }})</h3>
      {{ range .Alerts.Resolved }}
      <div class="alert resolved">
        <h4>{{ .Labels.alertname }}</h4>
        <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>

        <p><strong>Labels:</strong></p>
        <div>
          {{ range .Labels.SortedPairs }}
          <span class="label">{{ .Name }}: {{ .Value }}</span>
          {{ end }}
        </div>

        <p style="font-size: 12px; color: #666;">
          <strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}<br>
          <strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}<br>
          <strong>Duration:</strong> {{ .EndsAt.Sub .StartsAt }}
        </p>
      </div>
      {{ end }}
      {{ end }}

      <div class="footer">
        <p>
          This alert was sent by Alertmanager for Todo AI Chatbot.<br>
          <a href="{{ .ExternalURL }}">View in Alertmanager</a>
        </p>
      </div>
    </body>
    </html>
    {{ end }}

  slack.tmpl: |
    {{ define "slack.default.text" }}
    {{ if eq .Status "firing" }}
    *Status:* ðŸ”´ FIRING
    *Alerts Firing:* {{ .Alerts.Firing | len }}
    {{ else }}
    *Status:* âœ… RESOLVED
    *Alerts Resolved:* {{ .Alerts.Resolved | len }}
    {{ end }}

    {{ range .Alerts }}
    ---
    *Alert:* {{ .Labels.alertname }}
    *Severity:* {{ .Labels.severity | toUpper }}
    {{ if .Labels.service }}*Service:* {{ .Labels.service }}{{ end }}
    {{ if .Labels.pod }}*Pod:* {{ .Labels.pod }}{{ end }}
    {{ if .Labels.node }}*Node:* {{ .Labels.node }}{{ end }}

    *Summary:* {{ .Annotations.summary }}
    *Description:* {{ .Annotations.description }}

    {{ if eq .Status "firing" }}
    *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
    {{ else }}
    *Duration:* {{ .EndsAt.Sub .StartsAt }}
    {{ end }}

    <{{ .Annotations.dashboard }}|ðŸ“Š Dashboard> | <{{ .Annotations.runbook }}|ðŸ“– Runbook>
    {{ end }}

    <{{ .ExternalURL }}|View in Alertmanager>
    {{ end }}

  pagerduty.tmpl: |
    {{ define "pagerduty.default.description" }}
    {{ if eq .Status "firing" }}
    [FIRING:{{ .Alerts.Firing | len }}] {{ .GroupLabels.alertname }}
    {{ else }}
    [RESOLVED] {{ .GroupLabels.alertname }}
    {{ end }}
    {{ end }}

    {{ define "pagerduty.default.details" }}
    {
      "status": "{{ .Status }}",
      "severity": "{{ .CommonLabels.severity }}",
      "service": "{{ .CommonLabels.service }}",
      "alerts_firing": {{ .Alerts.Firing | len }},
      "alerts_resolved": {{ .Alerts.Resolved | len }},
      "group_labels": "{{ .GroupLabels.SortedPairs.Values | join ", " }}",
      "common_annotations": "{{ .CommonAnnotations.SortedPairs.Values | join ", " }}"
    }
    {{ end }}
