# Task: T5.6.4 - Alertmanager Configuration
# Implements: phase5-spec.md Section 7.4 (Alerting)
# Generated by: cicd-monitoring-agent
# Date: 2026-02-15

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app: alertmanager
    component: alerting
data:
  alertmanager.yml: |
    global:
      # Global configuration
      resolve_timeout: 5m

      # SMTP configuration for email alerts
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@todo-app.com'
      smtp_auth_username: 'alerts@todo-app.com'
      smtp_auth_password: '${SMTP_PASSWORD}'
      smtp_require_tls: true

      # Slack webhook URL (configure via secret)
      slack_api_url: '${SLACK_WEBHOOK_URL}'

      # Discord webhook URL (configure via secret)
      # discord_webhook_url: '${DISCORD_WEBHOOK_URL}'

      # PagerDuty integration key (optional)
      # pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # Templates for alert notifications
    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    # Route tree for alert routing
    route:
      # Default receiver for all alerts
      receiver: 'default-receiver'

      # Group alerts by these labels
      group_by: ['alertname', 'cluster', 'service']

      # Wait time before sending initial notification
      group_wait: 30s

      # Wait time before sending notification about new alerts in group
      group_interval: 5m

      # Wait time before re-sending notification
      repeat_interval: 4h

      # Child routes for specific alert types
      routes:
        # Critical alerts to PagerDuty (if configured)
        - match:
            severity: critical
          receiver: 'pagerduty-critical'
          continue: true
          group_wait: 10s
          repeat_interval: 1h

        # Critical alerts to Slack
        - match:
            severity: critical
          receiver: 'slack-critical'
          continue: true

        # Warning alerts to Slack
        - match:
            severity: warning
          receiver: 'slack-warnings'
          continue: false

        # Application alerts
        - match:
            category: application
          receiver: 'slack-application'
          group_by: ['alertname', 'service']

        # Infrastructure alerts
        - match:
            category: infrastructure
          receiver: 'slack-infrastructure'
          group_by: ['alertname', 'pod', 'node']

        # Kafka alerts
        - match:
            category: kafka
          receiver: 'slack-kafka'
          group_by: ['alertname', 'topic', 'consumergroup']

        # Dapr alerts
        - match:
            category: dapr
          receiver: 'slack-dapr'
          group_by: ['alertname', 'component', 'pod']

    # Inhibition rules to prevent alert storms
    inhibit_rules:
      # Inhibit warning alerts if critical alert is firing for same service
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service', 'cluster']

      # Inhibit high latency alerts if service is down
      - source_match:
          alertname: 'ServiceDown'
        target_match:
          alertname: 'HighLatency'
        equal: ['service', 'cluster']

      # Inhibit application alerts if pod is in restart loop
      - source_match:
          alertname: 'PodRestartLoop'
        target_match:
          category: 'application'
        equal: ['pod', 'cluster']

      # Inhibit Dapr alerts if sidecar is unhealthy
      - source_match:
          alertname: 'DaprSidecarUnhealthy'
        target_match:
          category: 'dapr'
        equal: ['pod', 'cluster']

    # Alert receivers configuration
    receivers:
      # Default receiver (email)
      - name: 'default-receiver'
        email_configs:
          - to: 'team@todo-app.com'
            headers:
              Subject: '[Todo App] Alert: {{ .GroupLabels.alertname }}'
            html: '{{ template "email.default.html" . }}'
            send_resolved: true

      # PagerDuty for critical alerts (optional)
      - name: 'pagerduty-critical'
        pagerduty_configs:
          - service_key: '${PAGERDUTY_SERVICE_KEY}'
            description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
              service: '{{ .GroupLabels.service }}'
              severity: '{{ .GroupLabels.severity }}'
            send_resolved: true

      # Slack for critical alerts
      - name: 'slack-critical'
        slack_configs:
          - channel: '#alerts-critical'
            username: 'Alertmanager'
            icon_emoji: ':fire:'
            title: ':fire: Critical Alert: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            color: 'danger'
            send_resolved: true
            actions:
              - type: button
                text: 'View Dashboard'
                url: '{{ (index .Alerts 0).Annotations.dashboard }}'
              - type: button
                text: 'View Runbook'
                url: '{{ (index .Alerts 0).Annotations.runbook }}'

      # Slack for warning alerts
      - name: 'slack-warnings'
        slack_configs:
          - channel: '#alerts-warnings'
            username: 'Alertmanager'
            icon_emoji: ':warning:'
            title: ':warning: Warning: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            color: 'warning'
            send_resolved: true

      # Slack for application alerts
      - name: 'slack-application'
        slack_configs:
          - channel: '#alerts-application'
            username: 'Alertmanager'
            icon_emoji: ':computer:'
            title: 'Application Alert: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            send_resolved: true

      # Slack for infrastructure alerts
      - name: 'slack-infrastructure'
        slack_configs:
          - channel: '#alerts-infrastructure'
            username: 'Alertmanager'
            icon_emoji: ':gear:'
            title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            send_resolved: true

      # Slack for Kafka alerts
      - name: 'slack-kafka'
        slack_configs:
          - channel: '#alerts-kafka'
            username: 'Alertmanager'
            icon_emoji: ':kafka:'
            title: 'Kafka Alert: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            send_resolved: true

      # Slack for Dapr alerts
      - name: 'slack-dapr'
        slack_configs:
          - channel: '#alerts-dapr'
            username: 'Alertmanager'
            icon_emoji: ':dapr:'
            title: 'Dapr Alert: {{ .GroupLabels.alertname }}'
            text: '{{ template "slack.default.text" . }}'
            send_resolved: true
