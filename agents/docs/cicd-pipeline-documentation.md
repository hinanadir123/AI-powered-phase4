# CI/CD Pipeline Documentation
# Task: T5.6.1 - Comprehensive CI/CD Pipeline
# Generated by: cicd-monitoring-agent
# Reference: phase5-spec.md Section 6.1, constitution.md Section 6

## Overview

This document describes the comprehensive CI/CD pipeline for the Todo AI Chatbot project. The pipeline automates building, testing, and deploying the application to staging and production environments using GitHub Actions.

## Architecture

### Pipeline Components

```
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub Repository                        │
│                    (Push to main or PR created)                  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Actions Workflow                     │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  Build Job   │→ │   Test Job   │→ │ Deploy Stage │         │
│  │              │  │              │  │              │         │
│  │ - Lint       │  │ - Unit Tests │  │ - Staging    │         │
│  │ - Build      │  │ - Integration│  │ - Production │         │
│  │ - Docker     │  │ - E2E Tests  │  │   (Manual)   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Container Registry                          │
│                        (Docker Hub)                              │
│                                                                  │
│  - todo-backend:latest, todo-backend:{sha}                      │
│  - todo-frontend:latest, todo-frontend:{sha}                    │
│  - reminder-worker:latest, reminder-worker:{sha}                │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Kubernetes Clusters                           │
│                                                                  │
│  ┌──────────────────┐         ┌──────────────────┐             │
│  │  Staging Cluster │         │ Production Cluster│             │
│  │  (Auto Deploy)   │         │ (Manual Approval) │             │
│  └──────────────────┘         └──────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## Workflows

### 1. Main Deployment Workflow (deploy.yml)

**Location**: `.github/workflows/deploy.yml`

**Triggers**:
- Push to `main` branch
- Pull request to `main` branch
- Manual workflow dispatch

**Jobs**:

#### Job 1: Build and Lint
- Checkout code
- Set up Node.js and Python environments
- Install dependencies with caching
- Run linters (ESLint, Prettier, Pylint, Black)
- Build frontend application
- Build and push Docker images to registry
  - Backend image
  - Frontend image
  - Reminder worker image

**Outputs**: Docker images tagged with git SHA and `latest`

#### Job 2: Test
- Run unit tests for backend (pytest)
- Run unit tests for frontend (npm test)
- Run integration tests
- Run E2E tests (Playwright)
- Generate code coverage reports
- Upload coverage to Codecov

**Requirements**: PostgreSQL service container

#### Job 3: Deploy to Staging
- Install kubectl and Helm
- Configure kubectl with staging kubeconfig
- Deploy backend, frontend, and worker using Helm
- Run smoke tests
- Validate health endpoints
- Send deployment notifications

**Trigger**: Automatic on push to main (after tests pass)

#### Job 4: Deploy to Production
- Install kubectl and Helm
- Configure kubectl with production kubeconfig
- Deploy backend, frontend, and worker using Helm
- Run smoke tests
- Monitor for errors (5-minute window)
- Automatic rollback on failure
- Send deployment notifications

**Trigger**: Manual approval required (GitHub environment protection)

### 2. Test-Only Workflow (test.yml)

**Location**: `.github/workflows/test.yml`

**Triggers**:
- Pull requests to `main` or `develop`
- Push to `develop` branch

**Jobs**:
- Lint: Code quality checks
- Unit Tests: Backend and frontend unit tests
- Integration Tests: API and database integration tests
- E2E Tests: End-to-end user flow tests
- Security Scan: Trivy vulnerability scanning

**Purpose**: Fast feedback for pull requests without deployment

## Scripts

### 1. Build Images Script

**Location**: `scripts/build-images.sh`

**Purpose**: Build and push Docker images for all services

**Usage**:
```bash
# Build images locally
export DOCKER_USERNAME=your-username
export IMAGE_TAG=v1.0.0
./scripts/build-images.sh

# Build and push images
export PUSH_IMAGES=true
./scripts/build-images.sh
```

**Features**:
- Builds backend, frontend, and worker images
- Tags images with custom tag and git SHA
- Optional push to registry
- Color-coded output
- Error handling

### 2. Deployment Script

**Location**: `scripts/deploy.sh`

**Purpose**: Deploy application to Kubernetes cluster

**Usage**:
```bash
# Deploy to staging
export DOCKER_USERNAME=your-username
export IMAGE_TAG=latest
./scripts/deploy.sh staging

# Deploy to production
./scripts/deploy.sh production
```

**Features**:
- Creates namespace if not exists
- Deploys backend, frontend, and worker
- Configures replica counts based on environment
- Waits for pods to be ready
- Shows deployment status
- Automatic rollback on failure

### 3. Smoke Tests Script

**Location**: `scripts/smoke-tests.sh`

**Purpose**: Validate deployment health

**Usage**:
```bash
# Run smoke tests for staging
./scripts/smoke-tests.sh staging

# Run smoke tests for production
./scripts/smoke-tests.sh production
```

**Tests**:
- Pod health (running and ready)
- Database connectivity
- Kafka/Dapr connectivity
- Backend health endpoint
- Frontend health endpoint
- Backend API endpoints
- Resource usage

## GitHub Secrets Configuration

All required secrets must be configured in GitHub repository settings. See `agents/docs/github-secrets-setup.md` for detailed instructions.

### Required Secrets

| Secret Name | Description | Required For |
|-------------|-------------|--------------|
| `DOCKER_USERNAME` | Docker Hub username | Build job |
| `DOCKER_PASSWORD` | Docker Hub password/token | Build job |
| `KUBECONFIG_STAGING` | Base64-encoded staging kubeconfig | Staging deployment |
| `KUBECONFIG_PRODUCTION` | Base64-encoded production kubeconfig | Production deployment |
| `AZURE_CREDENTIALS` | Azure service principal (if using AKS) | Azure deployments |
| `GCP_CREDENTIALS` | GCP service account (if using GKE) | GCP deployments |

### Optional Secrets

| Secret Name | Description | Used For |
|-------------|-------------|----------|
| `CODECOV_TOKEN` | Codecov API token | Coverage reporting |
| `SLACK_WEBHOOK_URL` | Slack webhook for notifications | Deployment notifications |
| `DISCORD_WEBHOOK_URL` | Discord webhook for notifications | Deployment notifications |

## Environment Configuration

### Staging Environment

**Namespace**: `todo-staging`

**Configuration**:
- Replica count: 1 for all services
- Auto-deploy on push to main
- No manual approval required
- URL: `https://staging.todo-app.example.com`

### Production Environment

**Namespace**: `todo-production`

**Configuration**:
- Replica count: 3 for backend/frontend, 2 for worker
- Manual approval required
- 5-minute error monitoring window
- Automatic rollback on failure
- URL: `https://todo-app.example.com`

## Deployment Flow

### Automatic Deployment (Staging)

1. Developer pushes code to `main` branch
2. GitHub Actions triggers deploy workflow
3. Build job: Lint, build, and push Docker images
4. Test job: Run all tests
5. Deploy-staging job: Deploy to staging cluster
6. Smoke tests validate deployment
7. Notification sent on success/failure

### Manual Deployment (Production)

1. Staging deployment completes successfully
2. Deploy-production job waits for manual approval
3. Reviewer approves deployment in GitHub UI
4. Production deployment begins
5. Services deployed with higher replica counts
6. Smoke tests validate deployment
7. 5-minute monitoring window
8. Automatic rollback if errors detected
9. Notification sent on success/failure

## Monitoring and Rollback

### Error Monitoring

Production deployments include a 5-minute monitoring window:
- Checks pod logs for error messages
- Counts error occurrences
- Triggers rollback if error count > 10

### Automatic Rollback

If deployment fails or errors are detected:
```bash
helm rollback todo-backend -n todo-production
helm rollback todo-frontend -n todo-production
helm rollback reminder-worker -n todo-production
```

### Manual Rollback

To manually rollback a deployment:
```bash
# List release history
helm history todo-backend -n todo-production

# Rollback to specific revision
helm rollback todo-backend <revision> -n todo-production
```

## Best Practices

### 1. Semantic Versioning

Use semantic versioning for releases:
```bash
git tag v1.0.0
git push origin v1.0.0
```

### 2. Branch Protection

Configure branch protection rules:
- Require pull request reviews
- Require status checks to pass
- Require branches to be up to date

### 3. Environment Protection

Configure environment protection rules:
- Require reviewers for production
- Limit deployment to specific branches
- Add deployment delay if needed

### 4. Secret Rotation

Rotate secrets regularly:
- Docker Hub tokens: Every 90 days
- Kubernetes credentials: Every 180 days
- Service account keys: Every 90 days

### 5. Monitoring

Monitor pipeline metrics:
- Build success rate
- Test pass rate
- Deployment frequency
- Mean time to recovery (MTTR)

## Troubleshooting

### Build Failures

**Symptom**: Build job fails

**Common Causes**:
- Linting errors
- Dependency installation failures
- Docker build failures

**Solution**:
1. Check workflow logs
2. Run linters locally: `npm run lint`, `black --check .`
3. Test Docker build locally: `docker build -t test ./backend`

### Test Failures

**Symptom**: Test job fails

**Common Causes**:
- Unit test failures
- Integration test failures
- Database connection issues

**Solution**:
1. Run tests locally: `pytest`, `npm test`
2. Check test logs in workflow
3. Verify database service is running

### Deployment Failures

**Symptom**: Deploy job fails

**Common Causes**:
- Invalid kubeconfig
- Insufficient permissions
- Helm chart errors
- Resource constraints

**Solution**:
1. Verify kubeconfig is correct
2. Check kubectl access: `kubectl get pods`
3. Validate Helm chart: `helm lint ./charts/todo-backend`
4. Check cluster resources: `kubectl top nodes`

### Smoke Test Failures

**Symptom**: Smoke tests fail after deployment

**Common Causes**:
- Pods not ready
- Health endpoints not responding
- Database connectivity issues

**Solution**:
1. Check pod status: `kubectl get pods -n todo-staging`
2. Check pod logs: `kubectl logs <pod-name> -n todo-staging`
3. Test health endpoint: `curl http://backend-url/health`

## Performance Optimization

### 1. Caching

The pipeline uses caching to speed up builds:
- Node.js dependencies cached by npm
- Python dependencies cached by pip
- Docker layer caching enabled

### 2. Parallel Jobs

Jobs run in parallel when possible:
- Lint and build run together
- Multiple test suites can run in parallel

### 3. Conditional Execution

Jobs run conditionally:
- Deploy jobs only run on main branch
- Production deploy requires manual trigger

## Security Considerations

### 1. Secret Management

- Never commit secrets to git
- Use GitHub Secrets for sensitive data
- Rotate secrets regularly

### 2. Image Scanning

- Trivy scans for vulnerabilities
- Results uploaded to GitHub Security

### 3. RBAC

- Use least privilege for service accounts
- Separate credentials for staging and production

### 4. Network Policies

- Restrict pod-to-pod communication
- Use network policies in Kubernetes

## Maintenance

### Regular Tasks

- **Weekly**: Review failed builds and fix issues
- **Monthly**: Update dependencies and base images
- **Quarterly**: Rotate secrets and credentials
- **Annually**: Review and update pipeline architecture

### Updates

To update the pipeline:
1. Modify workflow files in `.github/workflows/`
2. Test changes in a feature branch
3. Create pull request for review
4. Merge after approval

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Helm Documentation](https://helm.sh/docs/)
- [Kubernetes Documentation](https://kubernetes.io/docs/)
- [Docker Documentation](https://docs.docker.com/)

## Support

For issues or questions:
1. Check workflow logs in GitHub Actions tab
2. Review this documentation
3. Check troubleshooting section
4. Contact DevOps team

---

**Version**: 1.0
**Last Updated**: 2026-02-15
**Maintained by**: cicd-monitoring-agent
