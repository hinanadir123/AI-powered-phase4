# Kafka Event Schemas Documentation
## Todo AI Chatbot - Phase 5 Event-Driven Architecture

**Task:** T5.1.1 - Generate Kafka Topics Configuration
**Spec Reference:** phase5-spec.md Section 4.2 (Event Flow Diagram)
**Constitution:** constitution.md v5.0 Section 2.3 (Event-Driven Architecture Requirements)

**Version:** 1.0
**Date:** 2026-02-15
**Generated by:** kafka-dapr-engineer agent

---

## Table of Contents

1. [Overview](#overview)
2. [CloudEvents Standard](#cloudevents-standard)
3. [Topic: task-events](#topic-task-events)
   - [Event: task.created](#event-taskcreated)
   - [Event: task.updated](#event-taskupdated)
   - [Event: task.deleted](#event-taskdeleted)
   - [Event: task.completed](#event-taskcompleted)
4. [Topic: reminders](#topic-reminders)
   - [Event: reminder.scheduled](#event-reminderscheduled)
   - [Event: reminder.triggered](#event-remindertriggered)
5. [Topic: task-updates](#topic-task-updates)
   - [Event: task.sync](#event-tasksync)
6. [Error Handling and DLQ](#error-handling-and-dlq)
7. [Best Practices](#best-practices)

---

## Overview

This document defines the event schemas for all Kafka topics in the Todo AI Chatbot event-driven architecture. All events follow the CloudEvents v1.0 specification for consistency and interoperability.

### Key Principles

1. **CloudEvents Format**: All events use CloudEvents v1.0 specification
2. **Idempotency**: Events include unique IDs for deduplication
3. **Traceability**: Events include correlation IDs for distributed tracing
4. **Versioning**: Events include schema version for backward compatibility
5. **Timestamps**: All timestamps use ISO 8601 format (UTC)

---

## CloudEvents Standard

All events in this system follow the [CloudEvents v1.0 specification](https://cloudevents.io/).

### Required CloudEvents Attributes

| Attribute | Type | Description |
|-----------|------|-------------|
| `id` | string | Unique event identifier (UUID v4) |
| `source` | string | Event source (e.g., `/backend/api`, `/worker/reminder`) |
| `specversion` | string | CloudEvents version (always "1.0") |
| `type` | string | Event type (e.g., `task.created`, `reminder.triggered`) |
| `datacontenttype` | string | Content type of data (always "application/json") |
| `time` | string | Event timestamp (ISO 8601 UTC) |
| `data` | object | Event payload (schema varies by event type) |

### Optional CloudEvents Attributes

| Attribute | Type | Description |
|-----------|------|-------------|
| `subject` | string | Subject of the event (e.g., task ID) |
| `dataschema` | string | URI to event schema definition |

### Custom Extension Attributes

| Attribute | Type | Description |
|-----------|------|-------------|
| `correlationid` | string | Correlation ID for distributed tracing |
| `causationid` | string | ID of the event that caused this event |
| `userid` | string | User ID who triggered the event (future use) |
| `schemaversion` | string | Schema version (e.g., "1.0.0") |

---

## Topic: task-events

**Purpose:** Task lifecycle events (CRUD operations)
**Partitions:** 3
**Partition Key:** `task_id` (ensures ordering per task)
**Retention:** 7 days

### Event Types

1. `task.created` - New task created
2. `task.updated` - Existing task updated
3. `task.deleted` - Task deleted
4. `task.completed` - Task marked as completed

---

### Event: task.created

**Description:** Published when a new task is created.

**Publishers:** Backend API
**Subscribers:** Reminder Worker, Analytics Service (future)

**Schema:**

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "source": "/backend/api",
  "specversion": "1.0",
  "type": "task.created",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T10:30:00.000Z",
  "correlationid": "req-abc123",
  "schemaversion": "1.0.0",
  "data": {
    "task_id": "task-123",
    "title": "Complete project documentation",
    "description": "Write comprehensive documentation for Phase 5",
    "status": "pending",
    "priority": "high",
    "tags": ["documentation", "phase5"],
    "due_date": "2026-02-20T17:00:00.000Z",
    "recurrence": {
      "enabled": false,
      "interval": null,
      "frequency": null,
      "days": null,
      "end_date": null
    },
    "reminder": {
      "enabled": true,
      "time_before": "1h",
      "channels": ["email", "push"]
    },
    "created_at": "2026-02-15T10:30:00.000Z",
    "updated_at": "2026-02-15T10:30:00.000Z",
    "created_by": "user-456",
    "metadata": {
      "source": "web",
      "ip_address": "192.168.1.100"
    }
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.task_id` | string | Yes | Unique task identifier |
| `data.title` | string | Yes | Task title (max 200 chars) |
| `data.description` | string | No | Task description (max 2000 chars) |
| `data.status` | enum | Yes | Task status: `pending`, `in-progress`, `completed` |
| `data.priority` | enum | Yes | Priority: `low`, `medium`, `high`, `urgent` |
| `data.tags` | array[string] | No | Task tags/categories |
| `data.due_date` | string | No | Due date (ISO 8601 UTC) |
| `data.recurrence` | object | No | Recurrence configuration |
| `data.reminder` | object | No | Reminder configuration |
| `data.created_at` | string | Yes | Creation timestamp (ISO 8601 UTC) |
| `data.updated_at` | string | Yes | Last update timestamp (ISO 8601 UTC) |
| `data.created_by` | string | Yes | User ID who created the task |
| `data.metadata` | object | No | Additional metadata |

---

### Event: task.updated

**Description:** Published when an existing task is updated.

**Publishers:** Backend API
**Subscribers:** Reminder Worker, Frontend Sync Service

**Schema:**

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "source": "/backend/api",
  "specversion": "1.0",
  "type": "task.updated",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T11:45:00.000Z",
  "correlationid": "req-def456",
  "schemaversion": "1.0.0",
  "data": {
    "task_id": "task-123",
    "changes": {
      "priority": {
        "old": "medium",
        "new": "high"
      },
      "due_date": {
        "old": "2026-02-25T17:00:00.000Z",
        "new": "2026-02-20T17:00:00.000Z"
      }
    },
    "current_state": {
      "task_id": "task-123",
      "title": "Complete project documentation",
      "description": "Write comprehensive documentation for Phase 5",
      "status": "in-progress",
      "priority": "high",
      "tags": ["documentation", "phase5", "urgent"],
      "due_date": "2026-02-20T17:00:00.000Z",
      "recurrence": {
        "enabled": false
      },
      "reminder": {
        "enabled": true,
        "time_before": "1h",
        "channels": ["email", "push"]
      },
      "created_at": "2026-02-15T10:30:00.000Z",
      "updated_at": "2026-02-15T11:45:00.000Z",
      "created_by": "user-456"
    },
    "updated_by": "user-456",
    "update_reason": "Priority escalation due to deadline"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.task_id` | string | Yes | Task identifier |
| `data.changes` | object | Yes | Map of changed fields with old/new values |
| `data.current_state` | object | Yes | Complete current state of the task |
| `data.updated_by` | string | Yes | User ID who updated the task |
| `data.update_reason` | string | No | Reason for update (optional) |

---

### Event: task.deleted

**Description:** Published when a task is deleted.

**Publishers:** Backend API
**Subscribers:** Reminder Worker (to cancel scheduled reminders)

**Schema:**

```json
{
  "id": "770e8400-e29b-41d4-a716-446655440002",
  "source": "/backend/api",
  "specversion": "1.0",
  "type": "task.deleted",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T14:20:00.000Z",
  "correlationid": "req-ghi789",
  "schemaversion": "1.0.0",
  "data": {
    "task_id": "task-123",
    "deleted_at": "2026-02-15T14:20:00.000Z",
    "deleted_by": "user-456",
    "deletion_reason": "Task no longer relevant",
    "soft_delete": true,
    "previous_state": {
      "task_id": "task-123",
      "title": "Complete project documentation",
      "status": "in-progress",
      "priority": "high",
      "tags": ["documentation", "phase5", "urgent"],
      "due_date": "2026-02-20T17:00:00.000Z",
      "created_at": "2026-02-15T10:30:00.000Z"
    }
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.task_id` | string | Yes | Task identifier |
| `data.deleted_at` | string | Yes | Deletion timestamp (ISO 8601 UTC) |
| `data.deleted_by` | string | Yes | User ID who deleted the task |
| `data.deletion_reason` | string | No | Reason for deletion |
| `data.soft_delete` | boolean | Yes | True if soft delete (recoverable), false if hard delete |
| `data.previous_state` | object | Yes | Task state before deletion |

---

### Event: task.completed

**Description:** Published when a task is marked as completed.

**Publishers:** Backend API
**Subscribers:** Reminder Worker (to create next recurring instance), Analytics Service

**Schema:**

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "source": "/backend/api",
  "specversion": "1.0",
  "type": "task.completed",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T16:00:00.000Z",
  "correlationid": "req-jkl012",
  "schemaversion": "1.0.0",
  "data": {
    "task_id": "task-123",
    "title": "Complete project documentation",
    "completed_at": "2026-02-15T16:00:00.000Z",
    "completed_by": "user-456",
    "completion_notes": "All documentation completed and reviewed",
    "was_overdue": false,
    "recurrence": {
      "enabled": true,
      "interval": "weekly",
      "frequency": 1,
      "days": ["monday"],
      "end_date": "2026-12-31T23:59:59.000Z"
    },
    "next_occurrence": "2026-02-22T10:30:00.000Z",
    "created_at": "2026-02-15T10:30:00.000Z",
    "due_date": "2026-02-20T17:00:00.000Z"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.task_id` | string | Yes | Task identifier |
| `data.title` | string | Yes | Task title |
| `data.completed_at` | string | Yes | Completion timestamp (ISO 8601 UTC) |
| `data.completed_by` | string | Yes | User ID who completed the task |
| `data.completion_notes` | string | No | Notes about completion |
| `data.was_overdue` | boolean | Yes | True if completed after due date |
| `data.recurrence` | object | No | Recurrence config (if recurring task) |
| `data.next_occurrence` | string | No | Next occurrence timestamp (if recurring) |
| `data.created_at` | string | Yes | Original creation timestamp |
| `data.due_date` | string | No | Original due date |

---

## Topic: reminders

**Purpose:** Reminder scheduling and notification events
**Partitions:** 3
**Partition Key:** `task_id`
**Retention:** 7 days

### Event Types

1. `reminder.scheduled` - Reminder scheduled via Dapr Jobs API
2. `reminder.triggered` - Reminder notification triggered

---

### Event: reminder.scheduled

**Description:** Published when a reminder is scheduled for a task.

**Publishers:** Reminder Worker
**Subscribers:** Monitoring Service

**Schema:**

```json
{
  "id": "990e8400-e29b-41d4-a716-446655440004",
  "source": "/worker/reminder",
  "specversion": "1.0",
  "type": "reminder.scheduled",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T10:30:05.000Z",
  "correlationid": "req-abc123",
  "causationid": "550e8400-e29b-41d4-a716-446655440000",
  "schemaversion": "1.0.0",
  "data": {
    "reminder_id": "reminder-789",
    "task_id": "task-123",
    "task_title": "Complete project documentation",
    "scheduled_time": "2026-02-20T16:00:00.000Z",
    "trigger_time": "2026-02-20T16:00:00.000Z",
    "time_before_due": "1h",
    "due_date": "2026-02-20T17:00:00.000Z",
    "channels": ["email", "push"],
    "job_id": "dapr-job-reminder-789",
    "job_schedule": "2026-02-20T16:00:00.000Z",
    "created_at": "2026-02-15T10:30:05.000Z",
    "status": "scheduled"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.reminder_id` | string | Yes | Unique reminder identifier |
| `data.task_id` | string | Yes | Associated task identifier |
| `data.task_title` | string | Yes | Task title for notification |
| `data.scheduled_time` | string | Yes | When reminder was scheduled (ISO 8601 UTC) |
| `data.trigger_time` | string | Yes | When reminder will trigger (ISO 8601 UTC) |
| `data.time_before_due` | string | Yes | Time before due date (e.g., "1h", "30m", "1d") |
| `data.due_date` | string | Yes | Task due date (ISO 8601 UTC) |
| `data.channels` | array[string] | Yes | Notification channels: `email`, `push`, `sms` |
| `data.job_id` | string | Yes | Dapr Jobs API job identifier |
| `data.job_schedule` | string | Yes | Job execution time (ISO 8601 UTC) |
| `data.created_at` | string | Yes | Creation timestamp (ISO 8601 UTC) |
| `data.status` | enum | Yes | Status: `scheduled`, `cancelled`, `failed` |

---

### Event: reminder.triggered

**Description:** Published when a scheduled reminder is triggered.

**Publishers:** Reminder Worker (via Dapr Jobs API callback)
**Subscribers:** Notification Service, Frontend Sync Service

**Schema:**

```json
{
  "id": "aa0e8400-e29b-41d4-a716-446655440005",
  "source": "/worker/reminder",
  "specversion": "1.0",
  "type": "reminder.triggered",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-20T16:00:00.000Z",
  "correlationid": "req-abc123",
  "causationid": "990e8400-e29b-41d4-a716-446655440004",
  "schemaversion": "1.0.0",
  "data": {
    "reminder_id": "reminder-789",
    "task_id": "task-123",
    "task_title": "Complete project documentation",
    "task_description": "Write comprehensive documentation for Phase 5",
    "task_priority": "high",
    "task_status": "in-progress",
    "due_date": "2026-02-20T17:00:00.000Z",
    "time_until_due": "1h",
    "triggered_at": "2026-02-20T16:00:00.000Z",
    "channels": ["email", "push"],
    "notification_message": "Reminder: Task 'Complete project documentation' is due in 1 hour",
    "notification_title": "Task Due Soon",
    "notification_priority": "high",
    "action_url": "https://todo.example.com/tasks/task-123",
    "user_id": "user-456"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.reminder_id` | string | Yes | Reminder identifier |
| `data.task_id` | string | Yes | Task identifier |
| `data.task_title` | string | Yes | Task title |
| `data.task_description` | string | No | Task description |
| `data.task_priority` | enum | Yes | Task priority |
| `data.task_status` | enum | Yes | Current task status |
| `data.due_date` | string | Yes | Task due date (ISO 8601 UTC) |
| `data.time_until_due` | string | Yes | Time remaining until due (e.g., "1h", "30m") |
| `data.triggered_at` | string | Yes | Trigger timestamp (ISO 8601 UTC) |
| `data.channels` | array[string] | Yes | Notification channels |
| `data.notification_message` | string | Yes | Notification message text |
| `data.notification_title` | string | Yes | Notification title |
| `data.notification_priority` | enum | Yes | Notification priority: `low`, `medium`, `high` |
| `data.action_url` | string | Yes | Deep link to task |
| `data.user_id` | string | Yes | User to notify |

---

## Topic: task-updates

**Purpose:** Real-time task synchronization for frontend
**Partitions:** 3
**Partition Key:** `task_id`
**Retention:** 1 day (shorter retention for real-time updates)

### Event Types

1. `task.sync` - Real-time task update for frontend synchronization

---

### Event: task.sync

**Description:** Published for real-time frontend synchronization (lightweight version of task.updated).

**Publishers:** Backend API
**Subscribers:** Frontend Sync Service, WebSocket Gateway

**Schema:**

```json
{
  "id": "bb0e8400-e29b-41d4-a716-446655440006",
  "source": "/backend/api",
  "specversion": "1.0",
  "type": "task.sync",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T11:45:00.000Z",
  "correlationid": "req-def456",
  "schemaversion": "1.0.0",
  "data": {
    "task_id": "task-123",
    "action": "updated",
    "fields_changed": ["priority", "tags"],
    "snapshot": {
      "task_id": "task-123",
      "title": "Complete project documentation",
      "status": "in-progress",
      "priority": "high",
      "tags": ["documentation", "phase5", "urgent"],
      "due_date": "2026-02-20T17:00:00.000Z",
      "updated_at": "2026-02-15T11:45:00.000Z"
    },
    "user_id": "user-456",
    "session_id": "session-xyz"
  }
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `data.task_id` | string | Yes | Task identifier |
| `data.action` | enum | Yes | Action: `created`, `updated`, `deleted`, `completed` |
| `data.fields_changed` | array[string] | No | List of changed fields (for updates) |
| `data.snapshot` | object | Yes | Minimal task snapshot for UI update |
| `data.user_id` | string | Yes | User who triggered the change |
| `data.session_id` | string | No | Session ID (to avoid echoing back to originator) |

---

## Error Handling and DLQ

### Dead Letter Queue Events

When event processing fails after all retries, the event is sent to the corresponding DLQ topic with additional error metadata.

**DLQ Event Schema:**

```json
{
  "id": "cc0e8400-e29b-41d4-a716-446655440007",
  "source": "/worker/reminder",
  "specversion": "1.0",
  "type": "task.created",
  "datacontenttype": "application/json",
  "subject": "task-123",
  "time": "2026-02-15T10:30:00.000Z",
  "correlationid": "req-abc123",
  "schemaversion": "1.0.0",
  "data": {
    "original_event": {
      "...": "original event payload"
    },
    "error_metadata": {
      "error_type": "ProcessingException",
      "error_message": "Failed to schedule reminder: Database connection timeout",
      "error_stack": "...",
      "failed_at": "2026-02-15T10:30:10.000Z",
      "retry_count": 3,
      "last_retry_at": "2026-02-15T10:30:09.000Z",
      "processor": "reminder-worker-pod-1",
      "processor_version": "1.0.0"
    }
  }
}
```

### Retry Policy

Before sending to DLQ, events are retried with exponential backoff:

1. Initial retry: 1 second delay
2. Second retry: 2 seconds delay
3. Third retry: 4 seconds delay
4. After 3 retries: Send to DLQ

---

## Best Practices

### 1. Event Publishing

```javascript
// Example: Publishing task.created event via Dapr Pub/Sub
const event = {
  id: uuidv4(),
  source: '/backend/api',
  specversion: '1.0',
  type: 'task.created',
  datacontenttype: 'application/json',
  subject: taskId,
  time: new Date().toISOString(),
  correlationid: req.headers['x-correlation-id'] || uuidv4(),
  schemaversion: '1.0.0',
  data: {
    task_id: taskId,
    title: task.title,
    // ... rest of task data
  }
};

// Publish via Dapr HTTP API
await fetch('http://localhost:3500/v1.0/publish/pubsub-kafka/task-events', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(event)
});
```

### 2. Event Consumption

```javascript
// Example: Subscribing to task-events topic via Dapr
app.post('/dapr/subscribe', (req, res) => {
  res.json([
    {
      pubsubname: 'pubsub-kafka',
      topic: 'task-events',
      route: '/events/task-events'
    }
  ]);
});

app.post('/events/task-events', async (req, res) => {
  const event = req.body;

  // Idempotency check
  if (await isEventProcessed(event.id)) {
    return res.status(200).send('OK');
  }

  try {
    // Process event based on type
    switch (event.type) {
      case 'task.created':
        await handleTaskCreated(event.data);
        break;
      case 'task.updated':
        await handleTaskUpdated(event.data);
        break;
      // ... other event types
    }

    // Mark event as processed
    await markEventProcessed(event.id);

    res.status(200).send('OK');
  } catch (error) {
    // Return 500 to trigger retry
    res.status(500).send('Processing failed');
  }
});
```

### 3. Idempotency

Always implement idempotency checks using event IDs:

```javascript
// Store processed event IDs in Dapr State Store
async function isEventProcessed(eventId) {
  const state = await daprClient.state.get('statestore', `processed-event-${eventId}`);
  return state !== null;
}

async function markEventProcessed(eventId) {
  await daprClient.state.save('statestore', [
    {
      key: `processed-event-${eventId}`,
      value: { processedAt: new Date().toISOString() },
      options: { ttlInSeconds: 604800 } // 7 days TTL
    }
  ]);
}
```

### 4. Correlation and Causation

Always propagate correlation IDs and set causation IDs:

```javascript
// When publishing a new event caused by another event
const newEvent = {
  id: uuidv4(),
  correlationid: originalEvent.correlationid, // Same correlation ID
  causationid: originalEvent.id, // Original event ID as causation
  // ... rest of event
};
```

### 5. Schema Versioning

Include schema version in all events for backward compatibility:

```javascript
const event = {
  // ...
  schemaversion: '1.0.0',
  data: {
    // ... event data
  }
};

// When consuming, check schema version
if (event.schemaversion === '1.0.0') {
  // Process v1.0.0 schema
} else if (event.schemaversion === '2.0.0') {
  // Process v2.0.0 schema
}
```

---

## Appendix: Event Type Summary

| Topic | Event Type | Publisher | Subscribers | Purpose |
|-------|-----------|-----------|-------------|---------|
| task-events | task.created | Backend API | Reminder Worker, Analytics | New task created |
| task-events | task.updated | Backend API | Reminder Worker, Frontend Sync | Task updated |
| task-events | task.deleted | Backend API | Reminder Worker | Task deleted |
| task-events | task.completed | Backend API | Reminder Worker, Analytics | Task completed |
| reminders | reminder.scheduled | Reminder Worker | Monitoring | Reminder scheduled |
| reminders | reminder.triggered | Reminder Worker | Notification Service, Frontend Sync | Reminder triggered |
| task-updates | task.sync | Backend API | Frontend Sync, WebSocket Gateway | Real-time sync |

---

**END OF KAFKA EVENT SCHEMAS DOCUMENTATION**

*This document defines all event schemas for the Todo AI Chatbot event-driven architecture. All publishers and subscribers must adhere to these schemas for consistency and interoperability.*
