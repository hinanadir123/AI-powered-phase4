# Dapr Jobs API Component: Scheduler
# Task: T5.1.2 - Generate Dapr Component YAML Files
# Spec Reference: phase5-spec.md Section 4.3 (Dapr Components)
# Constitution: constitution.md v5.0 Section 4.3 (Dapr Components)
#
# This component enables scheduled job execution via Dapr Jobs API.
# It supports one-time and recurring jobs with cron expressions,
# retry policies, and job persistence using PostgreSQL state store.
#
# Version: 1.0
# Date: 2026-02-15
# Generated by: kafka-dapr-engineer agent

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: dapr-jobs
  namespace: default
spec:
  type: workmanager.jobscheduler
  version: v1
  metadata:
    - name: workManagerEndpoint
      value: "http://localhost:3500"
    - name: defaultConcurrency
      value: "10"
    - name: defaultPartitionCount
      value: "1"
    - name: maxRetries
      value: "3"
    - name: retryDelaySeconds
      value: "5"
    - name: defaultJobTimeout
      value: "3600"  # 1 hour in seconds
    - name: maxJobTimeout
      value: "86400"  # 24 hours in seconds
    - name: enableMetrics
      value: "true"
    - name: enableHealthChecks
      value: "true"
    - name: scopes
      value: "todo-api,reminder-worker"

---
# Jobs API Usage Examples
#
# Schedule a One-Time Job (Reminder):
# POST http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler
# Body: {
#   "name": "reminder-task-123",
#   "schedule": "2026-02-20T09:00:00Z",
#   "data": {
#     "task_id": "123",
#     "message": "Task due in 1 hour",
#     "channels": ["email", "push"]
#   },
#   "metadata": {
#     "priority": "8",
#     "tags": "reminder,task-123"
#   }
# }
#
# Schedule a Recurring Job (Daily Reminder):
# POST http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler
# Body: {
#   "name": "daily-summary",
#   "schedule": "@daily",  # or "0 9 * * *" for 9 AM daily
#   "repeats": -1,  # -1 = infinite repeats
#   "data": {
#     "type": "daily-summary"
#   }
# }
#
# Schedule a Recurring Task (Weekly):
# POST http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler
# Body: {
#   "name": "recurring-task-456",
#   "schedule": "0 10 * * MON",  # Every Monday at 10 AM
#   "repeats": -1,
#   "data": {
#     "task_id": "456",
#     "action": "create_next_instance"
#   }
# }
#
# Get Job Status:
# GET http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler/reminder-task-123
#
# Delete Job:
# DELETE http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler/reminder-task-123
#
# List All Jobs:
# GET http://localhost:3500/v1.0-alpha1/jobs/jobs-scheduler
#
# Job Execution Callback:
# When a job is triggered, Dapr will POST to your app's endpoint:
# POST http://localhost:3000/jobs/reminder-task-123
# Body: {
#   "name": "reminder-task-123",
#   "data": { ... },
#   "metadata": { ... }
# }

---
# Cron Expression Examples
#
# Every minute:        * * * * *
# Every 5 minutes:     */5 * * * *
# Every hour:          0 * * * *
# Every day at 9 AM:   0 9 * * *
# Every Monday at 10:  0 10 * * MON
# Every 1st of month:  0 0 1 * *
# Weekdays at 8 AM:    0 8 * * MON-FRI
#
# Predefined schedules:
# @yearly   = 0 0 1 1 *
# @monthly  = 0 0 1 * *
# @weekly   = 0 0 * * 0
# @daily    = 0 0 * * *
# @hourly   = 0 * * * *

---
# Job State Transitions
#
# SCHEDULED → RUNNING → COMPLETED
#                    → FAILED → RETRYING → RUNNING
#                                       → DEAD_LETTER
#
# Job Lifecycle:
# 1. Job is created with SCHEDULED state
# 2. At scheduled time, job transitions to RUNNING
# 3. Job executes and transitions to COMPLETED or FAILED
# 4. If FAILED and retries remain, transitions to RETRYING
# 5. If max retries exceeded, transitions to DEAD_LETTER
# 6. Job history is kept for configured retention period

---
# Monitoring and Alerting
#
# Metrics to Monitor:
# - dapr_jobs_scheduled_total: Total number of scheduled jobs
# - dapr_jobs_executed_total: Total number of executed jobs
# - dapr_jobs_failed_total: Total number of failed jobs
# - dapr_jobs_execution_duration_seconds: Job execution duration
# - dapr_jobs_queue_depth: Number of jobs waiting to execute
#
# Alert Rules:
# - Job failure rate > 10% for 5 minutes
# - Job execution duration > 5 minutes
# - Job queue depth > 100
# - No jobs executed in last 1 hour (if expecting regular jobs)
