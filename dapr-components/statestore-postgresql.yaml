# Dapr State Store Component: PostgreSQL
# Task: T5.1.2 - Generate Dapr Component YAML Files
# Spec Reference: phase5-spec.md Section 4.3 (Dapr Components)
# Constitution: constitution.md v5.0 Section 4.3 (Dapr Components)
#
# This component enables PostgreSQL-based state management via Dapr.
# It provides key-value storage with ACID transactions and supports
# state queries, bulk operations, and ETags for optimistic concurrency.
#
# Version: 1.0
# Date: 2026-02-15
# Generated by: kafka-dapr-engineer agent

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: postgresql-statestore
  namespace: default
spec:
  type: state.postgresql
  version: v1
  metadata:
    # Connection String
    - name: connectionString
      secretKeyRef:
        name: postgres-secrets
        key: connectionString

    # Tables and schema configuration
    - name: tableName
      value: "state_store"

    - name: schemaName
      value: "public"

    # Configuration for key-prefixing and key-management
    - name: keyColumnName
      value: "key"

    - name: valueColumnName
      value: "value"

    - name: urlColumnName
      value: "url"

    - name: versionColumnName
      value: "version"

    - name: metadataTableName
      value: "dapr_metadata"

    # Consistency and reliability settings
    - name: actorStateStore
      value: "true"

    # Timeouts and connection pool settings
    - name: databaseName
      value: "todoapp"

    - name: maxConns
      value: "10"

    - name: maxIdleConns
      value: "5"

    - name: connMaxLifetime
      value: "60m"

    - name: connMaxIdleTime
      value: "30m"

    # Component Scopes
    - name: scopes
      value: "todo-api,reminder-worker,notification-service,frontend-sync"

---
# Kubernetes Secret for PostgreSQL Connection String
# Create this secret before deploying Dapr components
#
# kubectl create secret generic postgres-secrets \
#   --from-literal=connectionString="host={POSTGRES_HOST} port=5432 user={POSTGRES_USER} password={POSTGRES_PASSWORD} dbname={POSTGRES_DB} sslmode=require"
#
# For Neon DB example:
# kubectl create secret generic postgres-secrets \
#   --from-literal=connectionString="host=ep-cool-meadow-123456.us-east-2.aws.neon.tech port=5432 user=neondb_owner password=your-password dbname=neondb sslmode=require"
#
# Verify secret:
# kubectl get secret postgres-secrets -o yaml

---
# State Store Usage Examples
#
# Save State:
# POST http://localhost:3500/v1.0/state/statestore-postgresql
# Body: [
#   {
#     "key": "task-123",
#     "value": { "id": "123", "title": "Buy groceries", "status": "pending" }
#   }
# ]
#
# Get State:
# GET http://localhost:3500/v1.0/state/statestore-postgresql/task-123
#
# Delete State:
# DELETE http://localhost:3500/v1.0/state/statestore-postgresql/task-123
#
# Bulk State Operations:
# POST http://localhost:3500/v1.0/state/statestore-postgresql/bulk
# Body: [
#   { "key": "task-123", "value": {...} },
#   { "key": "task-456", "value": {...} }
# ]
#
# Query State (with filters):
# POST http://localhost:3500/v1.0-alpha1/state/statestore-postgresql/query
# Body: {
#   "filter": {
#     "EQ": { "status": "pending" }
#   },
#   "sort": [
#     { "key": "createdAt", "order": "DESC" }
#   ],
#   "page": {
#     "limit": 10,
#     "token": ""
#   }
# }
#
# Transaction Example:
# POST http://localhost:3500/v1.0/state/statestore-postgresql/transaction
# Body: {
#   "operations": [
#     { "operation": "upsert", "request": { "key": "task-123", "value": {...} } },
#     { "operation": "delete", "request": { "key": "task-456" } }
#   ]
# }

---
# Database Schema
# Dapr will automatically create these tables on first use:
#
# CREATE TABLE dapr_state (
#   key TEXT PRIMARY KEY,
#   value JSONB NOT NULL,
#   isbinary BOOLEAN NOT NULL,
#   insertdate TIMESTAMP NOT NULL DEFAULT NOW(),
#   updatedate TIMESTAMP NOT NULL DEFAULT NOW()
# );
#
# CREATE TABLE dapr_state_metadata (
#   key TEXT PRIMARY KEY,
#   etag TEXT NOT NULL,
#   updatedate TIMESTAMP NOT NULL DEFAULT NOW()
# );
#
# CREATE INDEX idx_dapr_state_updatedate ON dapr_state(updatedate);
# CREATE INDEX idx_dapr_state_value ON dapr_state USING GIN(value);
