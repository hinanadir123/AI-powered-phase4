# Dapr Cron Binding Component: Scheduled Tasks
# Task: T5.1.2 - Generate Dapr Component YAML Files
# Spec Reference: phase5-spec.md Section 4.3 (Dapr Components)
# Constitution: constitution.md v5.0 Section 4.3 (Dapr Components)
#
# This component enables cron-based scheduled task execution via Dapr Bindings.
# It provides an alternative to Jobs API for simple recurring tasks that don't
# require persistence, retry logic, or complex scheduling.
#
# Version: 1.0
# Date: 2026-02-15
# Generated by: kafka-dapr-engineer agent

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: cron-binding
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
    - name: schedule
      value: "@every 1m"
    - name: data
      value: '{"source": "periodic-health-check"}'
    - name: scopes
      value: "reminder-worker"

---
# Additional Cron Bindings for Different Schedules

# Hourly Task Cleanup (remove completed tasks older than 30 days)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: bindings-cron-hourly-cleanup
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
    # Every hour at minute 0
    - name: schedule
      value: "0 0 * * * *"
    - name: timezone
      value: "UTC"
    - name: direction
      value: "input"
scopes:
  - todo-backend

---
# Weekly Report Generation (every Monday at 8:00 AM)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: bindings-cron-weekly-report
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
    # Every Monday at 8:00 AM
    - name: schedule
      value: "0 0 8 * * MON"
    - name: timezone
      value: "UTC"
    - name: direction
      value: "input"
scopes:
  - todo-backend

---
# Reminder Check (every 5 minutes)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: bindings-cron-reminder-check
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
    # Every 5 minutes
    - name: schedule
      value: "0 */5 * * * *"
    - name: timezone
      value: "UTC"
    - name: direction
      value: "input"
scopes:
  - reminder-worker

---
# Recurring Task Processor (every 15 minutes)
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: bindings-cron-recurring-tasks
  namespace: default
spec:
  type: bindings.cron
  version: v1
  metadata:
    # Every 15 minutes
    - name: schedule
      value: "0 */15 * * * *"
    - name: timezone
      value: "UTC"
    - name: direction
      value: "input"
scopes:
  - reminder-worker

---
# Cron Binding Usage Examples
#
# Receiving Cron Events in Your Application:
#
# 1. Create an endpoint to receive cron events:
#    POST /bindings/bindings-cron-daily-summary
#
# 2. Dapr will POST to this endpoint on schedule:
#    POST http://localhost:3000/bindings/bindings-cron-daily-summary
#    Body: {}
#
# 3. Your application processes the event:
#    - Generate daily summary
#    - Send email notifications
#    - Cleanup old data
#    - Trigger batch jobs
#
# Node.js/Express Example:
# app.post('/bindings/bindings-cron-daily-summary', async (req, res) => {
#   console.log('Daily summary cron triggered');
#   await generateDailySummary();
#   res.status(200).send();
# });
#
# Python/FastAPI Example:
# @app.post('/bindings/bindings-cron-daily-summary')
# async def daily_summary_cron():
#     logger.info('Daily summary cron triggered')
#     await generate_daily_summary()
#     return {'status': 'ok'}

---
# Cron Expression Format
#
# Format: second minute hour day month dayOfWeek
#
# Field        Allowed Values    Special Characters
# -----        --------------    ------------------
# second       0-59              * / , -
# minute       0-59              * / , -
# hour         0-23              * / , -
# day          1-31              * / , - ?
# month        1-12 or JAN-DEC   * / , -
# dayOfWeek    0-6 or SUN-SAT    * / , - ?
#
# Special Characters:
# * : All values (e.g., * in minute = every minute)
# / : Increments (e.g., */5 in minute = every 5 minutes)
# , : List (e.g., 1,15,30 in minute = at minutes 1, 15, and 30)
# - : Range (e.g., 1-5 in dayOfWeek = Monday to Friday)
# ? : No specific value (used in day or dayOfWeek)

---
# Common Cron Schedule Examples
#
# Every minute:
# 0 * * * * *
#
# Every 5 minutes:
# 0 */5 * * * *
#
# Every hour at minute 0:
# 0 0 * * * *
#
# Every day at midnight:
# 0 0 0 * * *
#
# Every day at 9:00 AM:
# 0 0 9 * * *
#
# Every Monday at 8:00 AM:
# 0 0 8 * * MON
#
# Every weekday at 6:00 PM:
# 0 0 18 * * MON-FRI
#
# First day of every month at midnight:
# 0 0 0 1 * *
#
# Every 15 minutes during business hours (9 AM - 5 PM):
# 0 */15 9-17 * * MON-FRI
#
# Every Sunday at 3:00 AM (weekly backup):
# 0 0 3 * * SUN

---
# Use Cases for Cron Bindings
#
# 1. Daily Summary Generation
#    - Schedule: 0 0 9 * * * (9:00 AM daily)
#    - Action: Generate and email daily task summary
#
# 2. Hourly Cleanup
#    - Schedule: 0 0 * * * * (every hour)
#    - Action: Delete completed tasks older than 30 days
#
# 3. Weekly Reports
#    - Schedule: 0 0 8 * * MON (Monday 8:00 AM)
#    - Action: Generate weekly productivity report
#
# 4. Reminder Checks
#    - Schedule: 0 */5 * * * * (every 5 minutes)
#    - Action: Check for due reminders and send notifications
#
# 5. Recurring Task Processing
#    - Schedule: 0 */15 * * * * (every 15 minutes)
#    - Action: Create next instances of recurring tasks
#
# 6. Database Maintenance
#    - Schedule: 0 0 2 * * * (2:00 AM daily)
#    - Action: Vacuum database, update statistics
#
# 7. Cache Invalidation
#    - Schedule: 0 */30 * * * * (every 30 minutes)
#    - Action: Clear expired cache entries
#
# 8. Health Checks
#    - Schedule: 0 */10 * * * * (every 10 minutes)
#    - Action: Ping external services, update status

---
# Cron Bindings vs Jobs API
#
# Use Cron Bindings when:
# - Simple recurring schedules (no complex logic)
# - No need for job persistence
# - No retry requirements
# - Stateless operations
# - Low criticality tasks
#
# Use Jobs API when:
# - One-time scheduled jobs
# - Complex retry logic required
# - Job persistence needed (survive restarts)
# - High criticality tasks (reminders, payments)
# - Need job history and monitoring
# - Dynamic scheduling (schedule jobs at runtime)
#
# Example Decision:
# - Daily summary email → Cron Binding (simple, recurring, low criticality)
# - User reminder notification → Jobs API (one-time, high criticality, needs retry)

---
# Monitoring Cron Bindings
#
# Metrics to Track:
# - Cron execution count
# - Cron execution duration
# - Cron execution failures
# - Last successful execution timestamp
#
# Logging:
# - Log every cron execution start
# - Log execution duration
# - Log any errors or exceptions
# - Include cron binding name in logs
#
# Example Log Entry:
# {
#   "timestamp": "2026-02-15T09:00:00Z",
#   "level": "INFO",
#   "message": "Cron binding triggered",
#   "binding": "bindings-cron-daily-summary",
#   "duration_ms": 1234
# }

---
# Troubleshooting
#
# Issue: Cron not triggering
# Solution: Verify cron expression syntax
# Test with: https://crontab.guru/ (for 5-field cron)
# Note: Dapr uses 6-field cron (includes seconds)
#
# Issue: Wrong timezone
# Solution: Set timezone metadata explicitly
# - name: timezone
#   value: "America/New_York"
#
# Issue: Multiple triggers at same time
# Solution: Ensure only one pod is handling cron events
# Use leader election or distributed locking
#
# Issue: Cron events not reaching application
# Solution: Verify endpoint exists and returns 200 OK
# Check Dapr sidecar logs: kubectl logs <pod> -c daprd
#
# Issue: Cron execution taking too long
# Solution: Move long-running tasks to background jobs
# Use Kafka events or Jobs API for async processing
